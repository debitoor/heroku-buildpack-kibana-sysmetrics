#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

CLOUD_ID_CMP="afdsf"
ELASTIC_USER_CMP="adsf"
ELASTIC_PASSWORD_CMP="adfas"

VERSION="7.6.1"
ARCHIVE_NAME=metricbeat-$VERSION-linux-x86_64.tar.gz
DIR_NAME=metricbeat-$VERSION-linux-x86_64

topic "Downloading metricbeat"
curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/$ARCHIVE_NAME

topic "Unpacking metricbeat"
tar xzvf $ARCHIVE_NAME
cd $DIR_NAME
rm -rf metricbeat.yml
cp ../metricbeat.yml .

topic "ENV variables to Metricbeat .yml"

sed -e "s/\${CLOUD_ID_CMP}/$CLOUD_ID_CMP/" -e "s/\${ELASTIC_USER_CMP}/$ELASTIC_USER_CMP/" -e "s/\${ELASTIC_PASSWORD_CMP}/$ELASTIC_PASSWORD_CMP/" metricbeat.yml | tee metricbeat.yml

cp -r ../$DIR_NAME $BUILD_DIR

topic "Installing Metricbeat runner"
mkdir -p "$BUILD_DIR/.profile.d"
cp "../extra/metricbeatRun.sh" "$BUILD_DIR/.profile.d/"
chmod +x "$BUILD_DIR/.profile.d/metricbeatRun.sh"

exit 0
