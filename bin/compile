#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

CLOUD_ID_CMP="$(cat $ENV_DIR/ELASTIC_CLOUD_ID)"
ELASTIC_USER_CMP="$(cat $ENV_DIR/ELASTIC_USER)"
ELASTIC_PASSWORD_CMP="$(cat $ENV_DIR/ELASTIC_PASSWORD)"

VERSION="7.6.1"
ARCHIVE_NAME=metricbeat-$VERSION-x86_64.rpm
DIR_NAME=metricbeat-$VERSION-darwin-x86_64/

topic "Downloading metricbeat"
curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/$ARCHIVE_NAME
rpm -vi metricbeat-7.6.1-x86_64.rpm

topic "Unpacking metricbeat"
#tar xzvf $ARCHIVE_NAME
#cd $DIR_NAME
rm -rf /etc/metricbeat/metricbeat.yml
cp ./metricbeat.yml /etc/metricbeat

topic "ENV variables to Metricbeat .yml"
sudo sed -e "s/\${CLOUD_ID_CMP}/$CLOUD_ID_CMP/" -e "s/\${ELASTIC_USER_CMP}/$ELASTIC_USER_CMP/" -e "s/\${ELASTIC_PASSWORD_CMP}/$ELASTIC_PASSWORD_CMP/" /etc/metricbeat/metricbeat.yml

topic "Installing Metricbeat runner"
mkdir -p "$BUILD_DIR/.profile.d"
cp "../extra/metricbeatRun.sh" "$BUILD_DIR/.profile.d/"
chmod +x "$BUILD_DIR/.profile.d/metricbeatRun.sh"

exit 0
